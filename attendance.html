<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - The Lalit Intl.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .att-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .st-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .btn-check:checked + .btn-outline-success { background-color: #198754; color: white; }
        .btn-check:checked + .btn-outline-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

<div class="main-content">
    <div class="container-fluid">
        <h2 style="font-family: 'Cinzel'; color: var(--royal-blue);" class="mb-4">Student Attendance</h2>

        <div class="att-card mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold">Select Class</label>
                    <select id="attClass" class="m-0">
                        <option value="">Choose Class...</option>
                        <option value="Nursery">Nursery</option>
                        <option value="LKG">LKG</option>
                        <option value="UKG">UKG</option>
                        <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Attendance Date</label>
                    <input type="date" id="attDate" class="m-0">
                </div>
                <div class="col-md-4">
                    <button class="main-btn w-100 m-0" onclick="loadAttendanceList()">LOAD STUDENTS</button>
                </div>
            </div>
        </div>

        <div id="listArea" class="royal-card" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Marking for: <span id="currentClass" class="text-primary"></span></h5>
                <button class="btn btn-sm btn-dark" onclick="markAllPresent()">Mark All Present</button>
            </div>
            
            <div id="attendanceTable">
                </div>

            <div class="text-center mt-4">
                <button class="main-btn w-50" id="saveAttBtn" onclick="saveAttendance()">SAVE ATTENDANCE</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
        authDomain: "the-lalit-d7472.firebaseapp.com",
        projectId: "the-lalit-d7472",
        appId: "1:479237084229:web:31078825739b3c5712ff2c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Default Date to Today
    document.getElementById('attDate').valueAsDate = new Date();

    async function loadAttendanceList() {
        const cls = document.getElementById('attClass').value;
        if(!cls) return alert("Select Class First");

        const container = document.getElementById('attendanceTable');
        container.innerHTML = "<p class='text-center py-4'>Fetching class list...</p>";
        document.getElementById('listArea').style.display = 'block';
        document.getElementById('currentClass').innerText = "Class " + cls;

        try {
            const snap = await db.collection('students').where("class", "==", cls).get();
            container.innerHTML = "";
            
            if(snap.empty) {
                container.innerHTML = "<p class='text-center py-4 text-danger'>No students in this class.</p>";
                return;
            }

            snap.forEach(doc => {
                const s = doc.data();
                container.innerHTML += `
                    <div class="st-row d-flex justify-content-between align-items-center" data-id="${s.uniqueID}" data-name="${s.name}">
                        <div>
                            <span class="fw-bold">${s.name}</span><br>
                            <small class="text-muted">ID: ${s.uniqueID}</small>
                        </div>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="att-${s.uniqueID}" id="p-${s.uniqueID}" value="Present" checked>
                            <label class="btn btn-outline-success btn-sm" for="p-${s.uniqueID}">P</label>

                            <input type="radio" class="btn-check" name="att-${s.uniqueID}" id="a-${s.uniqueID}" value="Absent">
                            <label class="btn btn-outline-danger btn-sm" for="a-${s.uniqueID}">A</label>
                        </div>
                    </div>`;
            });
        } catch (e) { alert(e.message); }
    }

    function markAllPresent() {
        const checks = document.querySelectorAll('input[value="Present"]');
        checks.forEach(c => c.checked = true);
    }

    async function saveAttendance() {
        const date = document.getElementById('attDate').value;
        const cls = document.getElementById('attClass').value;
        const btn = document.getElementById('saveAttBtn');
        const rows = document.querySelectorAll('.st-row');

        if(rows.length === 0) return;
        
        btn.disabled = true;
        btn.innerText = "Saving Registry...";

        const attendanceData = {
            class: cls,
            date: date,
            records: [],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const name = row.getAttribute('data-name');
            const status = document.querySelector(`input[name="att-${id}"]:checked`).value;
            attendanceData.records.push({ id, name, status });
        });

        try {
            // Using Date + Class as Doc ID to avoid duplicate entries for same day
            await db.collection('attendance').doc(`${date}-${cls}`).set(attendanceData);
            alert("Attendance Saved Successfully!");
        } catch (e) { alert(e.message); }
        finally {
            btn.disabled = false;
            btn.innerText = "SAVE ATTENDANCE";
        }
    }
</script>
<script src="menu.js"></script>
</body>
</html>
