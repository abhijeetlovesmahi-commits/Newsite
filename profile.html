<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - The Lalit Intl.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-header { background: var(--royal-blue); color: var(--gold); padding: 30px; border-radius: 15px; border-bottom: 5px solid var(--gold); }
        .st-photo-large { width: 150px; height: 150px; border-radius: 15px; border: 4px solid white; object-fit: cover; }
        .info-label { font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold; }
        .history-card { border-left: 4px solid var(--royal-blue); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="main-content">
    <div class="container">
        <div class="profile-header mb-4 shadow">
            <div class="row align-items-center text-center text-md-start">
                <div class="col-md-3">
                    <img id="pPhoto" src="https://via.placeholder.com/150" class="st-photo-large shadow">
                </div>
                <div class="col-md-9">
                    <h1 id="pName" style="font-family: 'Cinzel';">Loading...</h1>
                    <p class="mb-1"><i class="fas fa-id-badge me-2"></i> ID: <span id="pID">---</span></p>
                    <p><i class="fas fa-graduation-cap me-2"></i> Class: <span id="pClass">---</span> | Section: <span id="pSection">---</span></p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="royal-card h-100">
                    <h5 class="mb-3 border-bottom pb-2">Personal Details</h5>
                    <div class="mb-3">
                        <div class="info-label">Father's Name</div>
                        <div id="pFather" class="fw-bold">---</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Contact Number</div>
                        <div id="pMobile" class="fw-bold">---</div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">Residential Address</div>
                        <div id="pAddress" class="small">---</div>
                    </div>
                    <button class="btn btn-outline-dark w-100 mt-3 no-print" onclick="window.print()">
                        <i class="fas fa-print me-2"></i> Print Profile
                    </button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="royal-card h-100">
                    <h5 class="mb-3 border-bottom pb-2">Payment Ledger</h5>
                    <div id="pLedger">
                        <p class="text-center py-5">Syncing financial records...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
        authDomain: "the-lalit-d7472.firebaseapp.com",
        projectId: "the-lalit-d7472",
        appId: "1:479237084229:web:31078825739b3c5712ff2c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. Get ID from URL (e.g., profile.html?id=LIS-2026-1234)
    const urlParams = new URLSearchParams(window.location.search);
    const studentID = urlParams.get('id');

    async function loadProfile() {
        if(!studentID) {
            alert("No Student ID provided!");
            return;
        }

        try {
            // 2. Load Student Personal Data
            const doc = await db.collection('students').doc(studentID).get();
            if(!doc.exists) {
                alert("Student not found!");
                return;
            }
            const s = doc.data();
            document.getElementById('pName').innerText = s.name;
            document.getElementById('pID').innerText = s.uniqueID;
            document.getElementById('pClass').innerText = s.class;
            document.getElementById('pSection').innerText = s.section || 'A';
            document.getElementById('pFather').innerText = s.father;
            document.getElementById('pMobile').innerText = s.mobile || '-';
            document.getElementById('pAddress').innerText = s.address || 'N/A';
            if(s.photo) document.getElementById('pPhoto').src = s.photo;

            // 3. Load Student Fee History
            const feeSnap = await db.collection('fee_transactions')
                                    .where("studentID", "==", studentID)
                                    .orderBy("timestamp", "desc")
                                    .get();
            
            const ledger = document.getElementById('pLedger');
            ledger.innerHTML = "";

            if(feeSnap.empty) {
                ledger.innerHTML = "<p class='text-muted'>No fee payments recorded yet.</p>";
                return;
            }

            feeSnap.forEach(fDoc => {
                const f = fDoc.data();
                ledger.innerHTML += `
                    <div class="card p-2 history-card shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${f.month} Fee</span><br>
                                <small class="text-muted">Paid on: ${f.date}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">â‚¹${f.amount}</div>
                                <span class="badge bg-light text-dark border" style="font-size:10px">${f.mode}</span>
                            </div>
                        </div>
                    </div>`;
            });

        } catch (e) { console.error(e); }
    }

    window.onload = loadProfile;
</script>
<script src="menu.js"></script>
</body>
</html>
